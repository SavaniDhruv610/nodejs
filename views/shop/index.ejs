<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/index.css">
    <script src="https://use.fontawesome.com/fe459689b4.js"></script>
</head>

<body>
    <%- include('../includes/navigation.ejs') %>

    <main>
        <% if (prods.length > 0) { %>
            <div class="grid">
                <% for (let product of prods) { %>
                    <% if (!product.isDeleted) { %>
                        <article class="card product-item">
                            <div class="card__image">
                                <img src="/<%= product.imageUrl %>" alt="<%= product.title %>">
                            </div>
                            <div class="card__content">
                                <h1 class="product__title"><%= product.title %></h1>
                                <h2 class="product__price">â‚¹<%= product.price %></h2>
                                <p class="product__description">
                                    <%= product.description.length > 35 ? product.description.substring(0, 35) + "..." : product.description %>
                                </p>
                            </div>
                            <div class="card__actions">
                                <a href="/products/<%= product._id %>" class="btn">Details</a>
                                <% if (isAuthenticated) { %>
                                    <%- include('../includes/add-to-cart.ejs', { product: product, csrfToken: csrfToken }) %>
                                    <button class="btn like-button" id="like-<%= product._id %>">
                                        <i class="fa fa-thumbs-up fa-lg" aria-hidden="true"></i>
                                    </button>
                                    <button class="btn dislike-button" id="unlike-<%= product._id %>">
                                        <i class="fa fa-thumbs-down fa-lg" aria-hidden="true"></i>
                                    </button>
                                <% } %>
                            </div>
                        </article>
                    <% } %>
                <% } %>
            </div>
            <%- include('../includes/pagination.ejs', { currentPage: currentPage, lastPage: lastPage, nextPage: nextPage, hasPreviousPage: hasPreviousPage, hasNextPage: hasNextPage }) %>
        <% } else { %>
            <h1>No Products Found!</h1>
        <% } %>
    </main>

    <%- include('../includes/end.ejs') %>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- AJAX Script -->
    <script>
        $(document).ready(function () {
            // Function to fetch CSRF token
            function getCsrfToken() {
                return '<%= csrfToken %>'; // Use EJS syntax to get CSRF token
            }

            // Like and Unlike Button Click Handlers
            $('button[id^="like-"]').on('click', function () {
                const productId = $(this).attr('id').split('-')[1];
                const csrfToken = getCsrfToken();
                const likeButton = $(this);
                const unlikeButton = $(`#unlike-${productId}`);

                $.ajax({
                    url: `/products/like/${productId}`,
                    method: 'PUT',
                    headers: {
                        'csrf-token': csrfToken
                    },
                    success: function (response) {
                        console.log('Product liked successfully:', response);
                        likeButton.addClass('green');
                        unlikeButton.removeClass('red');
                    },
                    error: function (error) {
                        console.error('Error liking product:', error);
                        alert('Error liking product. Please try again later.');
                    }
                });
            });

            $('button[id^="unlike-"]').on('click', function () {
                const productId = $(this).attr('id').split('-')[1];
                const csrfToken = getCsrfToken();
                const unlikeButton = $(this);
                const likeButton = $(`#like-${productId}`);

                $.ajax({
                    url: `/products/unlike/${productId}`,
                    method: 'PUT',
                    headers: {
                        'csrf-token': csrfToken
                    },
                    success: function (response) {
                        console.log('Product unliked successfully:', response);
                        unlikeButton.addClass('red');
                        likeButton.removeClass('green');
                    },
                    error: function (error) {
                        console.error('Error unliking product:', error);
                        alert('Error unliking product. Please try again later.');
                    }
                });
            });
        });
    </script>
</body>

</html>
